# CaptiFi OpenWRT Integration - Nodogsplash Configuration
# This file configures Nodogsplash to work with CaptiFi

config nodogsplash
    # Enable Nodogsplash service
    option enabled '1'
    
    # Set gateway interface (typically the LAN interface)
    option gatewayinterface 'br-lan'
    
    # Gateway name/title that appears on the splash page
    option gatewayname 'CaptiFi Portal'
    
    # Splash page location
    option splashpage '/www/index.html'
    
    # Web server port for the portal
    option webroot '/www'
    option port '2050'
    
    # Authentication timeout in minutes (24 hours = 1440 minutes)
    option authidletimeout '1440'
    
    # Client timeouts
    option preauthidletimeout '30'
    option sessiontimeout '0'
    
    # Client quotas (0 = unlimited)
    option uploadrate '0'
    option downloadrate '0'
    option uploadquota '0'
    option downloadquota '0'
    
    # Configure allowed ports for preauthenticated users
    # Allow DNS lookups and HTTP/HTTPS for redirection only
    list preauthenticated_users_allowed_ports '53'
    list preauthenticated_users_allowed_ports '80'
    list preauthenticated_users_allowed_ports '443'
    
    # Block all other internet access until authenticated
    option blockalliptraffic '1'
    
    # Allow access to CaptiFi API for activation
    list users_to_router_allowed_ports '443'
    
    # Firewall rules
    list authenticated_users_allowed_ports '22'
    list authenticated_users_allowed_ports '53'
    list authenticated_users_allowed_ports '80'
    list authenticated_users_allowed_ports '443'
    
    # Enable logging
    option debuglevel '1'
    
    # BinAuth script for authentication handling
    # This will call our CaptiFi auth handler
    option binauth '/etc/captifi/scripts/auth-handler.sh'
    
    # Enable FAS (Forward Authentication Service)
    option fas_port '80'
    option faspath '/cgi-bin/pin-register'
    option fas_secure_enabled '0'
    
    # Additional settings for improved behavior
    option gatewayiprange '0.0.0.0/0'
    option maxclients '250'
    option clientforceimeout '120'
    
    # Use these to control how many devices a MAC address is allowed to use
    option maxmaclist '3'
    
    # Walled garden (allowed domains/URLs before authentication)
    # Allow access to CaptiFi resources and captive portal detection
    list walledgarden_fqdn_list 'app.captifi.io'
    
    # Apple Captive Portal Detection
    list walledgarden_fqdn_list 'captive.apple.com'
    list walledgarden_fqdn_list 'www.apple.com'
    
    # Google/Android Captive Portal Detection
    list walledgarden_fqdn_list 'connectivitycheck.gstatic.com'
    list walledgarden_fqdn_list 'connectivitycheck.android.com'
    list walledgarden_fqdn_list 'clients3.google.com'
    
    # Microsoft Captive Portal Detection
    list walledgarden_fqdn_list 'www.msftncsi.com'
    list walledgarden_fqdn_list 'www.msftconnecttest.com'
    
    # Captive portal detection timeout (shorter for faster detection)
    option preauthidletimeout '5'
    
    # Disable use of outdated libhttpd
    option use_outdated_mhd '0'
    
    # Force captive portal detection
    option redirectURL 'http://192.168.2.1/index.html'
    option gatewayname 'CaptiFi Portal'
    option daemon_timeout '5'
    option gatewayaddress '192.168.2.1'
